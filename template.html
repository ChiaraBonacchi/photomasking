<script src="http://ol3js.org/en/master/build/ol.js" type="text/javascript"></script>
<style>
    .map {
        height: 400px;
        width: 100%;
    }

</style>
<div class="row">
    <!-- Success and Error Messages for the user --> 
    <div class="span6 offset2" style="height:50px">
        <div id="success" class="alert alert-success" style="display:none;">
            <a class="close">×</a>
            <strong>Well done!</strong> Your answer has been saved
        </div>
        <div id="loading" class="alert alert-info" style="display:none;">
            <a class="close">×</a>
            Loading next task...
        </div>
        <div id="taskcompleted" class="alert alert-info" style="display:none;">
            <strong>The task has been completed!</strong> Thanks a lot!
        </div>
        <div id="finish" class="alert alert-success" style="display:none;">
            <strong>Congratulations!</strong> You have participated in all available tasks!
            <br/>
            <div class="alert-actions">
                <a class="btn small" href="/">Go back</a>
                <a class="btn small" href="/app">or, Check other applications</a>
            </div>
        </div>
        <div id="error" class="alert alert-error" style="display:none;">
            <a class="close">×</a>
            <strong>Error!</strong> Something went wrong, please contact the site administrators
        </div>
    </div> <!-- End Success and Error Messages for the user -->
</div> <!-- End of Row -->

<!--
    Task DOM for loading the Flickr Images
    It uses the class="skeleton" to identify the elements that belong to the
    task.
-->
<div class="row skeleton">
    <div class="span12">
        <h1>Draw the outline of the main object shown in the picture</h1>
    </div>
</div>
<div class="row skeleton"> <!-- Start Skeleton Row-->
    <div class="span8"><!-- Start of Photo DIV (column) -->
        <div id="map" class="img-polaroid"></div>
    </div><!-- End of Photo DIV (columnt) -->
    <div class="span4"><!-- Start of Question and Submission DIV (column) -->
        <!-- Feedback items for the user -->
        <p>You are working now on task: <span id="task-id" class="label label-warning">#</span></p>
        <p>You have completed: <span id="done" class="label label-info"></span> tasks from
        <!-- Progress bar for the user -->
        <span id="total" class="label label-inverse"></span></p>
        <div class="progress progress-striped">
            <div id="progress" rel="tooltip" title="#" class="bar" style="width: 0%;"></div>
        </div>

        <div id="answer"> <!-- Start DIV for the submission buttons -->
            <button id="btn-save" class="btn btn-success btn-answer" value='save'><i class="icon icon-white icon-save"></i> Save the outline</button>
        </div><!-- End of DIV for the submission buttons -->
        <!-- 
            This application uses Disqus to allow users to provide some feedback.
            The next section includes a button that when a user clicks on it will
            load the comments, if any, for the given task
        -->
        <div id="disqus_show_btn" style="margin-top:5px;">
            <button class="btn btn-primary btn-large btn-disqus" onclick="loadDisqus()"><i class="icon-comments"></i> Show comments</button>
            <button class="btn btn-large btn-disqus" onclick="loadDisqus()" style="display:none"><i class="icon-comments"></i> Hide comments</button>
        </div><!-- End of Disqus Button section -->

        <!-- Disqus thread for the given task -->
        <div id="disqus_thread" style="margin-top:5px;display:none"></div>

    </div><!-- End of Question and Submission DIV (column) -->

</div><!-- End of Skeleton Row -->

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */

    /* * * DON'T EDIT BELOW THIS LINE * * */
    function loadDisqus() {
    $("#disqus_thread").toggle();
    $(".btn-disqus").toggle();
    var disqus_shortname = 'pybossa'; // required: replace example with your forum shortname
    //var disqus_identifier = taskId;
    var disqus_developer = 1;

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    }

</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

<script>
function loadUserProgress() {
    pybossa.userProgress('flickrperson').done(function(data){
        var pct = Math.round((data.done*100)/data.total);
        $("#progress").css("width", pct.toString() +"%");
        $("#progress").attr("title", pct.toString() + "% completed!");
        $("#progress").tooltip({'placement': 'left'}); 
        $("#total").text(data.total);
        $("#done").text(data.done);
    });
}

pybossa.taskLoaded(function(task, deferred) {
    if ( !$.isEmptyObject(task) ) {
        // load image from flickr
        var img = $('<img />');
        var div_map = $('<div/>');
        div_map.css("height", "400px");
        div_map.css("width", "100%");

        $("#map").append(div_map);
        div_map.attr("id", "map_" + task.id);
        img.load(function() {
            // continue as soon as the image is loaded
            deferred.resolve(task);
        });
        img.attr('src', task.info.url_b).css('height', 460);
        img.addClass('img-polaroid');
        task.info.image = img;

        // Maps always need a projection, but the static image is not geo-referenced,
        // and are only measured in pixels.  So, we create a fake projection that the
        // map can use to properly display the layer.
        task.pixelProjection = new ol.proj.Projection({
          code: 'pixel',
          units: 'pixels',
          extent: [0, 0, 1024, 1024]
        });

        task.styleArray = [new ol.style.Style({
          fill: new ol.style.Fill({
            color: 'rgba(255, 255, 255, 0.2)'
          }),
          stroke: new ol.style.Stroke({
            color: '#ffcc33',
            width: 2
          }),
          image: new ol.style.Circle({
            radius: 7,
            fill: new ol.style.Fill({
              color: '#ffcc33'
            })
          })
        })];
        
        task.source = new ol.source.Vector();
        
        task.vector = new ol.layer.Vector({
          source: task.source,
          styleFunction: function(feature, resolution) {
            return task.styleArray;
          }
        });

        var overlayStyle = (function() {
            var styles = {};
            styles['Polygon'] = [
              new ol.style.Style({
                fill: new ol.style.Fill({
                  color: [255, 255, 255, 0.5]
                })
              }),
              new ol.style.Style({
                stroke: new ol.style.Stroke({
                  color: [255, 255, 255, 1],
                  width: 5
                })
              }),
              new ol.style.Style({
                stroke: new ol.style.Stroke({
                  color: [0, 153, 255, 1],
                  width: 3
                })
              })
            ];
            styles['MultiPolygon'] = styles['Polygon'];

            styles['LineString'] = [
              new ol.style.Style({
                stroke: new ol.style.Stroke({
                  color: [255, 255, 255, 1],
                  width: 5
                })
              }),
              new ol.style.Style({
                stroke: new ol.style.Stroke({
                  color: [0, 153, 255, 1],
                  width: 3
                })
              })
            ];
            styles['MultiLineString'] = styles['LineString'];

            styles['Point'] = [
              new ol.style.Style({
                image: new ol.style.Circle({
                  radius: 7,
                  fill: new ol.style.Fill({
                    color: [0, 153, 255, 1]
                  }),
                  stroke: new ol.style.Stroke({
                    color: [255, 255, 255, 0.75],
                    width: 1.5
                  })
                }),
                zIndex: 100000
              })
            ];
            styles['MultiPoint'] = styles['Point'];

            styles['GeometryCollection'] = styles['Polygon'].concat(styles['Point']);

            return function(feature, resolution) {
              return styles[feature.getGeometry().getType()];
            };
        })();

        task.overlay = new ol.FeatureOverlay({
            styleFunction: overlayStyle
        });

        task.modify = new ol.interaction.Modify({ 
                                                layer: task.vector,
                                                featureOverlay: task.overlay });
        task.select = new ol.interaction.Select({ 
                                                layer: task.vector,
                                                featureOverlay: task.overlay });
        
        task.map = new ol.Map({
          //interactions: ol.interaction.defaults().extend([task.select, task.modify]),
          layers: [
            new ol.layer.Image({
              source: new ol.source.ImageStatic({
                attributions: [
                  new ol.Attribution({
                    html: '&copy; <a href="http://xkcd.com/license.html">xkcd</a>'
                  })
                ],
                url: task.info.url_b,
                imageSize: [1024, 1024],
                projection: task.pixelProjection,
                imageExtent: task.pixelProjection.getExtent()
              })
            })
          , 
          task.vector
          ],
          renderer: 'canvas',
          target: 'map_' + task.id,
          view: new ol.View2D({
            projection: task.pixelProjection,
            center: ol.extent.getCenter(task.pixelProjection.getExtent()),
            zoom: 2
          })
        });
        div_map.css("display", "none");

        var typeSelect = document.getElementById('type');
        
        //task.draw; // global so we can remove it later
        task.draw = new ol.interaction.Draw({
          source: task.source,
          type: 'Polygon',
        });
        // When the first polygon is completed, remove the drawInteraction
        task.draw.on('drawend', function(evt) {
                task.map.removeInteraction(task.draw);
                task.map.addInteraction(task.select);
                task.map.addInteraction(task.modify);
                task.polygon = true;
                $("#btn-save").removeClass("disabled");
                });

        task.map.addInteraction(task.draw);

        task.answer = {
                 'task_id': task.id,
                 'polygon': [],
                 'img': task.info.url_b};
        task.polygon = false;
        }
    else {
        deferred.resolve(task);
    }
});

pybossa.presentTask(function(task, deferred) {
    if ( !$.isEmptyObject(task) ) {
        loadUserProgress();
        $("#btn-save").addClass("disabled");
        $('#task-id').html(task.id);
        $("#map_" + task.id).show();
        $('.btn-answer').off('click').on('click', function(evt) {
            var answer = $(evt.target).attr("value");
            if (typeof answer != 'undefined'){
                //console.log(answer);
                //console.log(task.map.source.features);
                if (task.polygon) {
                    var features = task.source.getAllFeatures();
                    for(i=0;i<features.length;i++) {
                        var g = features[i].getGeometry();
                        task.answer = {
                            'task_id': task.id,
                            'polygon': g.getCoordinates(),
                            'img': task.info.url_b};
                    }
                    pybossa.saveTask(task.id, task.answer).done(function() {
                        deferred.resolve();
                        $("#map_" + task.id).remove();
                    });
                    $("#loading").fadeIn(500);
                    if ($("#disqus_thread").is(":visible")) {
                        $('#disqus_thread').toggle();
                        $('.btn-disqus').toggle();
                    }
                } // end if task.polygon
            }
            else {
                $("#error").show();
            }
        });
        $("#loading").hide();
    }
    else {
        $(".skeleton").hide();
        $("#loading").hide();
        $("#finish").fadeIn(500);
    }
});

pybossa.run('ol3');
</script>
